<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ø³ÙˆØ¯ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø±ÛŒÙ¾ÛŒ</title>
  <style>
    body{font-family:IranSans, sans-serif;direction:rtl;background:#f5f5f5;margin:0;padding:0;text-align:center;color:#2d0c59}
    .container{max-width:460px;background:#fff;margin:30px auto;padding:24px;border-radius:25px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    img.logo{width:90px;margin-bottom:10px}
    h1{font-size:22px;margin:10px 0}
    p{font-size:14px;margin-bottom:16px;line-height:1.9}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
    .row.onecol{grid-template-columns:1fr}

    select,input[type="text"],input[type="number"]{
      width:100%;padding:12px;margin-bottom:12px;font-size:15px;border-radius:12px;border:1px solid #ccc;text-align:right;box-sizing:border-box
    }
    input[type="text"]{direction:ltr}
    button{background:#121212;color:#fff;border:none;padding:14px;font-size:16px;border-radius:12px;cursor:pointer;width:100%;margin:8px 0 16px}
    button:active{transform:translateY(1px)}
    .btn-secondary{background:#4332BD}
    .btn-ghost{background:#fff;color:#121212;border:1px solid #ddd}
    .mini{font-size:12px;color:#666}
    .result{background:#fafafa;padding:18px;border-radius:14px;text-align:right;line-height:1.9;white-space:pre-line}
    .error{color:#d33;font-size:12px;text-align:right;min-height:18px;margin:-6px 0 10px}
    .usage-counter{margin-top:10px;font-size:14px;color:#555}
    .hidden{display:none}
    .actions{display:flex;gap:8px;margin-top:10px}
    .actions button{flex:1;padding:10px;margin:0}

    /* CTA as link-button */
    a.btn-primary{display:block;text-decoration:none;text-align:center;background:#121212;color:#fff;border-radius:12px;padding:14px;margin:8px 0 16px}
    a.btn-primary:active{transform:translateY(1px)}

    /* ---- Download Modal ---- */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal{width:100%;max-width:420px;background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,.15)}
    .modal-header{background-image:linear-gradient(135deg,#4332BD,#6f58ff,#E96742);color:#fff;text-align:right;padding:14px 16px}
    .modal-header .close{background:transparent;border:0;color:#fff;font-size:18px;width:auto;float:left;margin-top:-4px;cursor:pointer}
    .modal-body{padding:10px;text-align:right}
    .option{display:flex;align-items:center;gap:10px;padding:12px;border-radius:14px;border:1px solid #eee;text-decoration:none;color:#111;margin:6px 0;transition:.15s ease;background:#fff}
    .option:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .option .arrow{margin-inline-start:auto;opacity:.8}
    .option.web:hover{border-color:#4332BD;background:rgba(67,50,189,.05)}
    .option.bazaar:hover{border-color:#E96742;background:rgba(233,103,66,.06)}
    .option.myket:hover{border-color:#0B0B0F;background:rgba(0,0,0,.05)}
  </style>
</head>
<body>
  <div class="container">
    <img src="https://uploadkon.ir/uploads/8c7604_25file-0000000073346243969ca320550ec0a2.png" class="logo" alt="Repay Logo" />
    <h1>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø³ÙˆØ¯ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h1>
    <p>Ø§Ø² Ø¨Ø§Ú©Ø³ Â«Ø·Ø±Ø­â€ŒÙ‡Ø§Â» Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯Ø› Ø§Ú¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø¯Ø§Ø´ØªØŒ Ø¨Ø§Ú©Ø³ Ø¯ÙˆÙ… ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>

    <!-- Download App Button -->
    <div style="margin-bottom:12px">
      <button id="btnOpenModal" type="button" class="btn-secondary">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</button>
    </div>

    <!-- Ø·Ø±Ø­â€ŒÙ‡Ø§ + Ø²ÛŒØ±Ø·Ø±Ø­ -->
    <div class="row" id="planRow">
      <div id="catWrap">
        <label class="mini" for="category">Ø·Ø±Ø­â€ŒÙ‡Ø§</label>
        <select id="category" aria-label="Ø·Ø±Ø­â€ŒÙ‡Ø§" onchange="onCategoryChange()">
          <option value="special" selected>ğŸ† Ø·Ø±Ø­ ÙˆÛŒÚ˜Ù‡</option>
          <option value="diamond">ğŸ’ Ø·Ø±Ø­ Ø§Ù„Ù…Ø§Ø³</option>
          <option value="hamrahi">â™¥ï¸ Ø·Ø±Ø­ Ù‡Ù…Ø±Ø§Ù‡ÛŒ (Ø¨Ø²ÙˆØ¯ÛŒ)</option>
        </select>
      </div>
      <div id="subWrap">
        <label class="mini" for="subplan">Ø§Ù†ØªØ®Ø§Ø¨ Ø²ÛŒØ±Ø·Ø±Ø­ (Ù…Ø¯Øª/Ø¯Ø±ØµØ¯)</label>
        <select id="subplan" aria-label="Ø²ÛŒØ±Ø·Ø±Ø­" onchange="onSubplanChange()" style="display:none"></select>
      </div>
    </div>

    <!-- Ù…Ø¨Ù„Øº -->
    <input id="amount" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)" />
    <div id="amountError" class="error"></div>

    <button id="calcBtn" type="button" onclick="calculate()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>

    <div class="result" id="result" aria-live="polite"></div>

    <div class="actions">
      <button id="btnCopy" class="btn-ghost" type="button" onclick="copyResult()">ğŸ“‹ Ú©Ù¾ÛŒ Ù†ØªÛŒØ¬Ù‡</button>
      <button id="btnShare" class="btn-ghost" type="button" onclick="shareResult()">ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</button>
    </div>

    <a id="ctaStart" class="btn-primary" href="https://my.repay.pro" target="_blank" rel="noreferrer noopener">Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø´Ø±ÙˆØ¹ Ú©Ù†</a>

    <div class="usage-counter">ğŸ“Š count : <span id="useCount">0</span></div>
  </div>

  <!-- Download Modal -->
  <div id="downloadModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="dl-title">
    <div class="modal">
      <div class="modal-header">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div id="dl-title" style="font-weight:700;">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø±ÛŒÙ¾ÛŒ</div>
          <button id="btnCloseModal" class="close" aria-label="Ø¨Ø³ØªÙ†">âœ•</button>
        </div>
        <div style="font-size:12px; opacity:.85; margin-top:4px;">ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
      </div>
      <div class="modal-body">
        <a class="option web" href="https://my.repay.pro" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">ğŸŒ</div>
          <div>
            <div style="font-weight:600;">ÙˆØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</div>
            <div style="font-size:12px; color:#666;">Ø¨Ø¯ÙˆÙ† Ù†ØµØ¨ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø®Ù„ Ù…Ø±ÙˆØ±Ú¯Ø±</div>
          </div>
          <div class="arrow">â†—</div>
        </a>
        <a class="option bazaar" href="http://cafebazaar.ir/app/?id=io.rebix.pay&ref=share" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">ğŸ›’</div>
          <div><div style="font-weight:600;">Ú©Ø§ÙÙ‡ Ø¨Ø§Ø²Ø§Ø±</div><div style="font-size:12px; color:#666;">Ù†ØµØ¨ Ø§Ø² Ù…Ø§Ø±Ú©Øª Ø¨Ø§Ø²Ø§Ø±</div></div>
          <div class="arrow">â†—</div>
        </a>
        <a class="option myket" href="https://myket.ir/app/io.rebix.pay" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">ğŸ“±</div>
          <div><div style="font-weight:600;">Ù…Ø§ÛŒÚ©Øª</div><div style="font-size:12px; color:#666;">Ù†ØµØ¨ Ø§Ø² Ù…Ø§Ø±Ú©Øª Ù…Ø§ÛŒÚ©Øª</div></div>
          <div class="arrow">â†—</div>
        </a>
      </div>
      <div style="background:#f6f6f6; color:#666; font-size:11px; text-align:right; padding:10px 12px;">
        Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ø± Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø¨Ù‡ ØµÙØ­Ù‡Ù” Ù†ØµØ¨ Ù…Ø±Ø¨ÙˆØ· Ù‡Ø¯Ø§ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯.
      </div>
    </div>
  </div>

  <script>
    // ====== Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ======
    const catalog = {
      special: {
        type: 'group',
        label: 'ğŸ† Ø·Ø±Ø­ ÙˆÛŒÚ˜Ù‡',
        children: {
          gold120: { label: "ğŸ… ÙˆÛŒÚ˜Ù‡ Û±Û²Û°Ùª (Û²Ø³Ø§Ù„Ù‡)", type: "termYield", termMonths: 24, termYield: 1.20, min: 9000000 },
          gold57:  { label: "ğŸ… ÙˆÛŒÚ˜Ù‡ ÛµÛ·Ùª (ÛŒÚ©Ø³Ø§Ù„Ù‡)",  type: "termYield", termMonths: 12, termYield: 0.57, min: 9000000 },
          gold25:  { label: "ğŸ… ÙˆÛŒÚ˜Ù‡ Û²ÛµÙª (Û¶Ù…Ø§Ù‡Ù‡)",   type: "termYield", termMonths: 6,  termYield: 0.25, min: 5000000 },
          gold9:   { label: "ğŸ… ÙˆÛŒÚ˜Ù‡ Û¹Ùª (Û³Ù…Ø§Ù‡Ù‡)",    type: "termYield", termMonths: 3,  termYield: 0.09, min: 5000000 },
        }
      },
      diamond: {
        type: 'group',
        label: 'ğŸ’ Ø·Ø±Ø­ Ø§Ù„Ù…Ø§Ø³',
        children: {
          dia60: { label: "ğŸ’ Ø§Ù„Ù…Ø§Ø³ Û¶Û°Ùª (Û±Û²Ù…Ø§Ù‡Ù‡) â€” Ø­Ø¯Ø§Ù‚Ù„ Ûµ,Û°Û°Û°,Û°Û°Û°",  type: "termYield", termMonths: 12, termYield: 0.60, min: 5_000_000 },
          dia63: { label: "ğŸ’ Ø§Ù„Ù…Ø§Ø³ Û¶Û³Ùª (Û±Û²Ù…Ø§Ù‡Ù‡) â€” Ø­Ø¯Ø§Ù‚Ù„ Û³Û°,Û°Û°Û°,Û°Û°Û°", type: "termYield", termMonths: 12, termYield: 0.63, min: 30_000_000 },
          dia66: { label: "ğŸ’ Ø§Ù„Ù…Ø§Ø³ Û¶Û¶Ùª (Û±Û²Ù…Ø§Ù‡Ù‡) â€” Ø­Ø¯Ø§Ù‚Ù„ Û±Û°Û°,Û°Û°Û°,Û°Û°Û°",type: "termYield", termMonths: 12, termYield: 0.66, min: 100_000_000 },
        }
      },
      hamrahi: { type: 'comingSoon', label: 'â™¥ï¸ Ø·Ø±Ø­ Ù‡Ù…Ø±Ø§Ù‡ÛŒ (Ø¨Ø²ÙˆØ¯ÛŒ)' }
    };

    // ====== ÙØ±Ù…Øª Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ ÙˆØ±ÙˆØ¯ÛŒ ======
    const nfFA = new Intl.NumberFormat('fa-IR');
    const formatNumber = (n) => nfFA.format(n);

    function normalizeDigits(str){
      const fa='Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹', ar='Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
      return (str||'').replace(/[\u06F0-\u06F9\u0660-\u0669]/g,d=>{
        const i=fa.indexOf(d); if(i>-1) return String(i);
        const j=ar.indexOf(d); if(j>-1) return String(j);
        return d;
      });
    }
    function numberFromInput(val){
      const normalized = normalizeDigits(val);
      const raw = normalized.replace(/[^\d]/g,'');
      return raw ? Math.min(parseInt(raw,10), Number.MAX_SAFE_INTEGER) : NaN;
    }
    function formatInputAmount(e){
      const input=e.target;
      const n=numberFromInput(input.value);
      if(Number.isNaN(n)){ input.value=''; return; }
      input.value = formatNumber(n);
    }
    function setError(msg){
      document.getElementById('amountError').textContent = msg || '';
    }

    // ====== Ù…Ø­Ø§Ø³Ø¨Ø§Øª ======
    function calcTermYield(P, termYield, termMonths){
      const profit = Math.round(P * termYield);
      const monthly = Math.round(profit / termMonths);
      return { profit, monthly, finalAmount: P + profit };
    }

    // ====== UI Helpers ======
    function updateAmountPlaceholder(min){
      const txt = min>0
        ? `Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº ${formatNumber(min)} ØªÙˆÙ…Ø§Ù†`
        : 'Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)';
      document.getElementById('amount').placeholder = txt;
    }
    function toggleCTA(show){
      const a = document.getElementById('ctaStart');
      a.style.display = show ? '' : 'none';
    }
    function updateCtaLink(params = {}){
      const a = document.getElementById('ctaStart');
      const url = new URL('https://my.repay.pro');
      Object.entries(params).forEach(([k,v])=>{
        if(v!==undefined && v!==null && v!=='') url.searchParams.set(k,v);
      });
      a.href = url.toString();
    }
    function setRowCols(hasSub){
      const row = document.getElementById('planRow');
      row.classList.toggle('onecol', !hasSub);
      document.getElementById('subWrap').style.display = hasSub ? '' : 'none';
    }

    // ====== Ù…Ù†Ø·Ù‚ Ø§Ù†ØªØ®Ø§Ø¨ ======
    function onCategoryChange(){
      const catKey = document.getElementById('category').value;
      const cat = catalog[catKey];
      const subSel = document.getElementById('subplan');
      const calcBtn = document.getElementById('calcBtn');
      const resultEl = document.getElementById('result');

      // reset
      subSel.innerHTML = '';
      subSel.style.display = 'none';
      setError('');
      resultEl.textContent = '';
      toggleCTA(true);
      calcBtn.disabled = false;

      if(cat.type === 'group'){
        Object.entries(cat.children).forEach(([k,pl])=>{
          const opt=document.createElement('option');
          opt.value = k;
          opt.textContent = pl.label;
          subSel.appendChild(opt);
        });
        subSel.style.display = '';
        setRowCols(true);
        const firstChildKey = Object.keys(cat.children)[0];
        subSel.value = firstChildKey;
        const firstChild = cat.children[firstChildKey];
        updateAmountPlaceholder(firstChild.min);
        updateCtaLink({category: catKey, sub: firstChildKey});
      }
      else if(cat.type === 'comingSoon'){
        setRowCols(false);
        calcBtn.disabled = true;
        toggleCTA(false);
        updateAmountPlaceholder(0);
        resultEl.textContent = 'Ø§ÛŒÙ† Ø·Ø±Ø­ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.';
      }
    }

    function onSubplanChange(){
      const catKey = document.getElementById('category').value;
      const subKey = document.getElementById('subplan').value;
      const cat = catalog[catKey];
      if(!subKey || !cat?.children?.[subKey]) return;
      const pl = cat.children[subKey];
      updateAmountPlaceholder(pl.min);
      document.getElementById('result').textContent = '';
      setError('');
      updateCtaLink({category: catKey, sub: subKey});
    }

    // ====== Ù…Ø­Ø§Ø³Ø¨Ù‡ ======
    function calculate(){
      const catKey = document.getElementById('category').value;
      const cat = catalog[catKey];
      const amount = numberFromInput(document.getElementById('amount').value);
      const resultEl = document.getElementById('result');

      if(Number.isNaN(amount)){
        setError('Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        return;
      }

      if(cat.type === 'group'){
        const subKey = document.getElementById('subplan').value;
        const plan = catalog[catKey].children[subKey];

        if(amount < plan.min){
          setError(`Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº Ø¨Ø±Ø§ÛŒ Â«${plan.label}Â» ${formatNumber(plan.min)} ØªÙˆÙ…Ø§Ù† Ø§Ø³Øª.`);
          return;
        }
        setError('');

        const out = calcTermYield(amount, plan.termYield, plan.termMonths);
        const text =
`Ù…Ø¯Øª: ${plan.termMonths} Ù…Ø§Ù‡Ù‡
Ø³ÙˆØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${formatNumber(out.monthly)} ØªÙˆÙ…Ø§Ù†
Ø³ÙˆØ¯ Ú©Ù„: ${formatNumber(out.profit)} ØªÙˆÙ…Ø§Ù†
Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¯Ø± Ø³Ø±Ø±Ø³ÛŒØ¯: ${formatNumber(out.finalAmount)} ØªÙˆÙ…Ø§Ù†`;

        resultEl.textContent = text;
        updateCtaLink({category: catKey, sub: subKey, amount, months: plan.termMonths});
        updateCounter();
      }
      else if(cat.type === 'comingSoon'){
        resultEl.textContent = 'Ø§ÛŒÙ† Ø·Ø±Ø­ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.';
        return;
      }
    }

    // ====== Ú©Ù¾ÛŒ Ùˆ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ ======
    async function copyResult(){
      const btn = document.getElementById('btnCopy');
      const text = document.getElementById('result').textContent.trim();
      if(!text){ btnShake(btn); return; }
      try{
        await navigator.clipboard.writeText(text);
        flashBtn(btn, 'Ú©Ù¾ÛŒ Ø´Ø¯ âœ…');
      }catch(_){
        flashBtn(btn, 'Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ â—ï¸');
      }
    }
    async function shareResult(){
      const btn = document.getElementById('btnShare');
      const text = document.getElementById('result').textContent.trim();
      if(!text){ btnShake(btn); return; }
      const url = document.getElementById('ctaStart').href;
      const payload = { title: 'Ù†ØªÛŒØ¬Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒÙ¾ÛŒ', text, url };
      if(navigator.share){
        try{
          await navigator.share(payload);
          flashBtn(btn, 'Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ âœ…');
        } catch(_){ /* Ø§Ù†ØµØ±Ø§Ù Ú©Ø§Ø±Ø¨Ø± */ }
      }else{
        try{
          await navigator.clipboard.writeText(text + '\n' + url);
          flashBtn(btn, 'Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯ âœ…');
        }catch(_){
          flashBtn(btn, 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ â—ï¸');
        }
      }
    }
    function flashBtn(btn, msg){
      const old = btn.textContent;
      btn.textContent = msg;
      btn.disabled = true;
      setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1500);
    }
    function btnShake(btn){
      const old = btn.style.transform;
      btn.style.transform = 'translateX(-3px)';
      setTimeout(()=>{ btn.style.transform = 'translateX(3px)'; }, 80);
      setTimeout(()=>{ btn.style.transform = old || 'none'; }, 160);
    }

    // ====== Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ (GAS JSONP) ======
    const COUNTER_NS = 'repay_calc';
    const COUNTER_KEY = 'usage_count';
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxkeNkd__in37pKasVS0lhD7ffK7iB2dxS1A7hSgY8R9TngJLjfRwcIp4kuowDs7O-4/exec';
    const URL_GET = `${API_BASE}?op=get&ns=${COUNTER_NS}&key=${COUNTER_KEY}`;
    const URL_HIT = `${API_BASE}?op=hit&ns=${COUNTER_NS}&key=${COUNTER_KEY}`;

    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb='cb_'+Math.random().toString(36).slice(2);
        window[cb]=data=>{ resolve(data); cleanup(); };
        const s=document.createElement('script');
        s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
        s.onerror=()=>{ reject(); cleanup(); };
        document.body.appendChild(s);
        function cleanup(){ try{ delete window[cb]; }catch(_){} s.remove(); }
      });
    }
    function setCount(v){ document.getElementById('useCount').innerText = (v ?? 0); }
    function getCurrentCount(){ jsonp(URL_GET).then(d=>setCount(d.value)).catch(()=>setCount(0)); }
    function updateCounter(){
      const el=document.getElementById('useCount');
      el.innerText=(parseInt(el.innerText||'0',10)+1);
      jsonp(URL_HIT).then(d=>setCount(d.value)).catch(()=>{});
    }

    // ====== Ù…Ø¯Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ ======
    (function setupModal(){
      const modal=document.getElementById('downloadModal');
      const openBtn=document.getElementById('btnOpenModal');
      const closeBtn=document.getElementById('btnCloseModal');
      let lastFocus = null;

      function open(){
        lastFocus = document.activeElement;
        modal.style.display='flex';
        closeBtn.focus();
      }
      function close(){
        modal.style.display='none';
        if(lastFocus) lastFocus.focus();
      }
      openBtn.addEventListener('click', open);
      closeBtn.addEventListener('click', close);
      modal.addEventListener('click', e=>{ if(e.target===modal) close(); });
      document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
    })();

    // ====== init ======
    document.addEventListener('DOMContentLoaded', ()=>{
      const amountEl = document.getElementById('amount');
      amountEl.addEventListener('input', formatInputAmount);

      document.getElementById('category').value = 'special';
      onCategoryChange();

      const subSel = document.getElementById('subplan');
      if(subSel.options.length>0){
        subSel.value = subSel.options[0].value;
        onSubplanChange();
      }
      getCurrentCount();
    });
  </script>
</body>
</html>
