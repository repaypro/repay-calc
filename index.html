<!DOCTYPE html><html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ماشین‌حساب سود سرمایه‌گذاری ریپی</title>
  <style>
    body {
      font-family: IranSans, sans-serif;
      direction: rtl;
      background-color: #f5f5f5;
      margin: 0; padding: 0; text-align: center; color: #2d0c59;
    }
    .container {
      max-width: 460px; background: #fff; margin: 30px auto; padding: 24px;
      border-radius: 25px; box-shadow: 0 6px 20px rgba(0,0,0,.06);
    }
    img.logo { width: 90px; margin-bottom: 10px; }
    h1 { font-size: 22px; margin: 10px 0; }
    p { font-size: 14px; margin-bottom: 16px; line-height: 1.9; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; }

    select, input[type="text"], input[type="number"] {
      width: 100%; padding: 12px; margin-bottom: 12px; font-size: 15px;
      border-radius: 12px; border: 1px solid #ccc; text-align: right; box-sizing: border-box;
    }
    input[type="text"] { direction: ltr; }
    input[type="range"] { width: 100%; }

    button {
      background-color: #121212; color: #fff; border: none; padding: 14px; font-size: 16px;
      border-radius: 12px; cursor: pointer; width: 100%; margin: 8px 0 16px;
    }
    button:active { transform: translateY(1px); }

    .btn-secondary { background: #4332BD; }
    .mini { font-size: 12px; color: #666; }

    .result {
      background-color: #fafafa; padding: 18px; border-radius: 14px; text-align: right;
      line-height: 1.9; white-space: pre-line;  /* مهم: خطوط خروجی دقیق نمایش داده شوند */
    }
    .error { color: #d33; font-size: 12px; text-align: right; min-height: 18px; margin: -6px 0 10px; }
    .usage-counter { margin-top: 10px; font-size: 14px; color: #555; }

    /* ---- Download Modal ---- */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.4); backdrop-filter: blur(3px);
      display: none; align-items: center; justify-content: center; padding: 16px; z-index: 999;
    }
    .modal {
      width: 100%; max-width: 420px; background: #fff; border-radius: 20px; overflow: hidden;
      box-shadow: 0 12px 32px rgba(0,0,0,.15);
    }
    .modal-header {
      background-image: linear-gradient(135deg, #4332BD, #6f58ff, #E96742);
      color: #fff; text-align: right; padding: 14px 16px;
    }
    .modal-header .close {
      background: transparent; border: 0; color: #fff; font-size: 18px; width: auto;
      float: left; margin-top: -4px; cursor: pointer;
    }
    .modal-body { padding: 10px; text-align: right; }
    .option {
      display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 14px;
      border: 1px solid #eee; text-decoration: none; color: #111; margin: 6px 0;
      transition: .15s ease; background: #fff;
    }
    .option:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,.06); }
    .option .arrow { margin-inline-start: auto; opacity: .8; }
    .option.web:hover { border-color: #4332BD; background: rgba(67,50,189,.05); }
    .option.bazaar:hover { border-color: #E96742; background: rgba(233,103,66,.06); }
    .option.myket:hover { border-color: #0B0B0F; background: rgba(0,0,0,.05); }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://uploadkon.ir/uploads/8c7604_25file-0000000073346243969ca320550ec0a2.png" class="logo" alt="Repay Logo" />
    <h1>ماشین حساب سود سرمایه‌گذاری</h1>
    <p>طرح را انتخاب کنید؛ مبلغ را وارد کنید تا جزئیات و دکمهٔ شروع سریع نمایش داده شود.</p>

    <!-- Download App Button -->
    <div style="margin-bottom:12px">
      <button id="btnOpenModal" type="button" class="btn-secondary">دانلود اپلیکیشن</button>
    </div>

    <div class="row">
      <select id="plan" aria-label="انتخاب طرح" onchange="onPlanChange()">
        <option value="gold123" selected>🥇 طلایی ۱۲۳٪</option>
        <option value="credit">💳 طرح اعتبار</option>
        <option value="vip">⭐ VIP (دلخواه)</option>
        <option value="upfront">💠 سود یکجا</option>
      </select>

      <!-- مدت: برای VIP غیرفعال می‌شود -->
      <select id="duration" aria-label="انتخاب مدت"></select>
    </div>

    <!-- VIP Controls -->
    <div id="vipControls" style="display:none; text-align:right; margin-top:-6px;">
      <label class="mini">مدت (ماه)</label>
      <input id="vipMonths" type="range" min="1" max="36" value="12" oninput="document.getElementById('vipMonthsVal').innerText=this.value">
      <div class="mini">مدت انتخابی: <b><span id="vipMonthsVal">12</span> ماه</b></div>

      <label class="mini" style="margin-top:8px;">درصد سود انتخابی</label>
      <input id="vipAPR" type="range" min="0.01" max="0.61" step="0.01" value="0.30"
             oninput="document.getElementById('vipAPRVal').innerText=(this.value*100).toFixed(2)+'%'">
      <div class="mini">درصد سود انتخابی: <b><span id="vipAPRVal">30.00%</span></b></div>
    </div>

    <input id="amount" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="مبلغ سرمایه (تومان)" />
    <div id="amountError" class="error"></div>

    <button id="calcBtn" type="button" onclick="calculate()">محاسبه</button>

    <div class="result" id="result" aria-live="polite"></div>

    <a id="ctaStart" href="https://my.repay.pro" target="_blank" rel="noreferrer noopener">
      <button type="button">همین الان شروع کن</button>
    </a>

    <div class="usage-counter">📊 count : <span id="useCount">0</span></div>
  </div>

  <!-- Download Modal -->
  <div id="downloadModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="dl-title">
    <div class="modal">
      <div class="modal-header">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div id="dl-title" style="font-weight:700;">دانلود و نصب اپلیکیشن ریپی</div>
          <button id="btnCloseModal" class="close" aria-label="بستن">✕</button>
        </div>
        <div style="font-size:12px; opacity:.85; margin-top:4px;">یکی از گزینه‌های زیر را انتخاب کنید</div>
      </div>
      <div class="modal-body">
        <a class="option web" href="https://my.repay.pro" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">🌐</div>
          <div>
            <div style="font-weight:600;">وب اپلیکیشن</div>
            <div style="font-size:12px; color:#666;">بدون نصب، مستقیم داخل مرورگر</div>
          </div>
          <div class="arrow">↗</div>
        </a>
        <a class="option bazaar" href="http://cafebazaar.ir/app/?id=io.rebix.pay&ref=share" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">🛒</div>
          <div>
            <div style="font-weight:600;">کافه بازار</div>
            <div style="font-size:12px; color:#666;">نصب از مارکت بازار</div>
          </div>
          <div class="arrow">↗</div>
        </a>
        <a class="option myket" href="https://myket.ir/app/io.rebix.pay" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">📱</div>
          <div>
            <div style="font-weight:600;">مایکت</div>
            <div style="font-size:12px; color:#666;">نصب از مارکت مایکت</div>
          </div>
          <div class="arrow">↗</div>
        </a>
      </div>
      <div style="background:#f6f6f6; color:#666; font-size:11px; text-align:right; padding:10px 12px;">
        با انتخاب هر گزینه، به صفحهٔ نصب مربوط هدایت می‌شوید.
      </div>
    </div>
  </div>

<script>
  // ---------- Plans ----------
  // مبلغ‌ها: تومان
  const plans = {
    gold123: {
      label: "طلایی ۱۲۳٪",
      type: "termYield",
      termMonths: 24,
      termYield: 1.23,     // سود کل دوره
      min: 25000000,       // حداقل 25,000,000 تومان
    },
    credit: {
      label: "طرح اعتبار",
      type: "dailyAPR_withLoan",
      termMonths: 3,
      investAPR: 0.25,     // سالانه روزشمار
      loanAPR: 0.23,       // سالانه روزشمار
      loanFactor: 1/3,     // یک سوم سرمایه
      min: 15000000,
    },
    vip: {
      label: "VIP",
      type: "dailyAPR_flexible",
      minMonths: 1,
      maxMonths: 36,
      minAPR: 0.01,
      maxAPR: 0.61,
      min: 0,
    },
    upfront: {
      label: "سود یکجا",
      type: "dailyAPR_upfront",
      termMonths: 5,
      apr: 0.42,
      min: 10000000,
    }
  };

  // ---------- Formatting ----------
  const nfFA = new Intl.NumberFormat('fa-IR');
  const formatNumber = (n) => nfFA.format(n);

  function normalizeDigits(str){
    const fa = '۰۱۲۳۴۵۶۷۸۹', ar = '٠١٢٣٤٥٦٧٨٩';
    return (str || '').replace(/[\u06F0-\u06F9\u0660-\u0669]/g, d => {
      const i = fa.indexOf(d); if (i > -1) return String(i);
      const j = ar.indexOf(d); if (j > -1) return String(j);
      return d;
    });
  }
  function numberFromInput(val){
    const normalized = normalizeDigits(val);
    const raw = normalized.replace(/[^\d]/g, '');
    return raw ? parseInt(raw, 10) : NaN;
  }
  function formatInputAmount(e){
    const input = e.target;
    const n = numberFromInput(input.value);
    if (Number.isNaN(n)) { input.value = ''; return; }
    input.value = formatNumber(n);
  }
  function setError(msg){ document.getElementById('amountError').textContent = msg || ''; }

  // ---------- Daily APR (roozshomar) ----------
  const proratedByMonths = (apr, months) => apr * ((months * 30) / 365);

  // ---------- UI logic ----------
  function onPlanChange(){
    const key = document.getElementById('plan').value;
    const p = plans[key];
    const sel = document.getElementById('duration');
    const vipBox = document.getElementById('vipControls');

    sel.innerHTML = '';
    vipBox.style.display = 'none';
    sel.disabled = false;

    if (p.type === 'termYield') {
      const opt = document.createElement('option');
      opt.value = String(p.termMonths);
      opt.textContent = `${p.termMonths} ماهه`;
      sel.appendChild(opt);
    } else if (p.type === 'dailyAPR_withLoan') {
      const opt = document.createElement('option');
      opt.value = String(p.termMonths);
      opt.textContent = `${p.termMonths} ماهه`;
      sel.appendChild(opt);
    } else if (p.type === 'dailyAPR_upfront') {
      const opt = document.createElement('option');
      opt.value = String(p.termMonths);
      opt.textContent = `${p.termMonths} ماهه`;
      sel.appendChild(opt);
    } else if (p.type === 'dailyAPR_flexible') {
      vipBox.style.display = '';
      sel.disabled = true;
    }

    const minTxt = p.min > 0 ? `حداقل مبلغ ${formatNumber(p.min)} تومان` : 'مبلغ سرمایه (تومان)';
    document.getElementById('amount').placeholder = minTxt;

    setError('');
    document.getElementById('result').innerHTML = '';
  }

  // ---------- Calculations ----------
  function calcTermYield(P, termYield){
    const profit = Math.round(P * termYield);
    const monthly = Math.round(profit / 24);
    return { profit, monthly, finalAmount: P + profit };
  }
  function calcDailyAPR(P, apr, months){
    const r = proratedByMonths(apr, months);
    const profit = Math.round(P * r);
    const monthly = Math.max(0, Math.round(profit / months));
    return { r, profit, monthly, finalAmount: P + profit };
  }
  function calcCreditPlan(P){
    const pl = plans.credit;
    const inv = calcDailyAPR(P, pl.investAPR, pl.termMonths);
    const loanAmount  = Math.round(P * pl.loanFactor);
    const loanRate    = proratedByMonths(pl.loanAPR, pl.termMonths);
    const loanInterest = Math.round(loanAmount * loanRate);
    const loanMonthly  = Math.round(loanInterest / pl.termMonths);
    return {
      investProfit: inv.profit,
      investMonthly: inv.monthly,
      finalAmount: P + inv.profit,
      loanAmount, loanMonthly
    };
  }
  function calcUpfront(P){
    const pl = plans.upfront;
    const r = proratedByMonths(pl.apr, pl.termMonths);
    const upfrontInterest = Math.round(P * r);
    const monthly = Math.round(upfrontInterest / pl.termMonths);
    return {
      monthly, total: upfrontInterest, finalAtMaturity: P
    };
  }

  // ---------- Show result (STRICT templates) ----------
  function calculate(){
    const key = document.getElementById('plan').value;
    const p = plans[key];
    const amount = numberFromInput(document.getElementById('amount').value);

    if (Number.isNaN(amount)) { setError('مبلغ را وارد کنید.'); return; }
    if (amount < p.min) { setError(`حداقل مبلغ برای «${p.label}» ${formatNumber(p.min)} تومان است.`); return; }
    setError('');

    const months = (p.type === 'dailyAPR_flexible')
      ? parseInt(document.getElementById('vipMonths').value, 10)
      : parseInt(document.getElementById('duration').value, 10);

    let text = '';
    if (p.type === 'termYield') {
      const out = calcTermYield(amount, p.termYield);
      text =
`مدت: ${p.termMonths} ماهه
سود ماهانه: ${formatNumber(out.monthly)} تومان
سود کل: ${formatNumber(out.profit)} تومان
مبلغ قابل برداشت در سررسید: ${formatNumber(out.finalAmount)} تومان`;
    } else if (p.type === 'dailyAPR_withLoan') {
      const out = calcCreditPlan(amount);
      // نسخه مرتب و منظم طبق قالب خواسته‌شده
      text =
`مدت: ${p.termMonths} ماهه
سود ماهانه: ${formatNumber(out.investMonthly)} تومان
سود کل: ${formatNumber(out.investProfit)} تومان
مبلغ قابل برداشت در سررسید: ${formatNumber(out.finalAmount)} تومان
---------------------------------
اعتبار دریافتی : ${formatNumber(out.loanAmount)} تومان
سود ماهانه اعتبار : ${formatNumber(out.loanMonthly)} تومان`;
    } else if (p.type === 'dailyAPR_flexible') {
      const apr = Math.min(Math.max(parseFloat(document.getElementById('vipAPR').value), p.minAPR), p.maxAPR);
      const out = calcDailyAPR(amount, apr, months);
      text =
`مدت: ${months} ماهه
سود ماهانه: ${formatNumber(out.monthly)} تومان
سود کل: ${formatNumber(out.profit)} تومان
مبلغ قابل برداشت در سررسید: ${formatNumber(out.finalAmount)} تومان`;
    } else if (p.type === 'dailyAPR_upfront') {
      const out = calcUpfront(amount);
      text =
`مدت: ${p.termMonths} ماهه
سود ماهانه: ${formatNumber(out.monthly)} تومان
سود کل: ${formatNumber(out.total)} تومان
مبلغ قابل برداشت در سررسید: ${formatNumber(out.finalAtMaturity)} تومان`;
    }

    // نمایش دقیق همان قالب (بدون اطلاعات اضافه)
    const resultEl = document.getElementById('result');
    resultEl.textContent = text;

    updateCounter(); // شمارنده
  }

  // ---------- Counter (GAS JSONP) ----------
  const COUNTER_NS  = 'repay_calc';        // همان namespace شما (بدون صفر شدن)
  const COUNTER_KEY = 'usage_count';
  const API_BASE = 'https://script.google.com/macros/s/AKfycbxkeNkd__in37pKasVS0lhD7ffK7iB2dxS1A7hSgY8R9TngJLjfRwcIp4kuowDs7O-4/exec';

  const URL_GET = `${API_BASE}?op=get&ns=${COUNTER_NS}&key=${COUNTER_KEY}`;
  const URL_HIT = `${API_BASE}?op=hit&ns=${COUNTER_NS}&key=${COUNTER_KEY}`;

  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      window[cb] = data => { resolve(data); cleanup(); };
      const s = document.createElement('script');
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
      s.onerror = () => { reject(); cleanup(); };
      document.body.appendChild(s);
      function cleanup(){ delete window[cb]; s.remove(); }
    });
  }
  function setCount(v){ document.getElementById('useCount').innerText = (v ?? 0); }
  function getCurrentCount(){ jsonp(URL_GET).then(d => setCount(d.value)).catch(() => setCount(0)); }
  function updateCounter(){
    const el = document.getElementById('useCount');
    el.innerText = (parseInt(el.innerText || '0', 10) + 1);
    jsonp(URL_HIT).then(d => setCount(d.value)).catch(() => {});
  }

  // ---------- Download Modal logic ----------
  (function setupModal(){
    const modal = document.getElementById('downloadModal');
    const openBtn = document.getElementById('btnOpenModal');
    const closeBtn = document.getElementById('btnCloseModal');

    function open(){ modal.style.display = 'flex'; }
    function close(){ modal.style.display = 'none'; }

    openBtn.addEventListener('click', open);
    closeBtn.addEventListener('click', close);
    modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
  })();

  // ---------- init ----------
  document.getElementById('amount').addEventListener('input', formatInputAmount);
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('plan').value = 'gold123'; // پیش‌فرض
    onPlanChange();
    getCurrentCount();
  });
</script>
</body>
</html>
