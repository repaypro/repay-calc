<!DOCTYPE html><html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ø³ÙˆØ¯ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø±ÛŒÙ¾ÛŒ</title>
  <style>
    body {
      font-family: IranSans, sans-serif;
      direction: rtl;
      background-color: #f5f5f5;
      margin: 0; padding: 0; text-align: center; color: #2d0c59;
    }
    .container {
      max-width: 460px; background: #fff; margin: 30px auto; padding: 24px;
      border-radius: 25px; box-shadow: 0 6px 20px rgba(0,0,0,.06);
    }
    img.logo { width: 90px; margin-bottom: 10px; }
    h1 { font-size: 22px; margin: 10px 0; }
    p { font-size: 14px; margin-bottom: 16px; line-height: 1.9; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; }

    select, input[type="text"], input[type="number"] {
      width: 100%; padding: 12px; margin-bottom: 12px; font-size: 15px;
      border-radius: 12px; border: 1px solid #ccc; text-align: right; box-sizing: border-box;
    }
    input[type="text"] { direction: ltr; }
    input[type="range"] { width: 100%; }

    button {
      background-color: #121212; color: #fff; border: none; padding: 14px; font-size: 16px;
      border-radius: 12px; cursor: pointer; width: 100%; margin: 8px 0 16px;
    }
    button:active { transform: translateY(1px); }

    .btn-secondary { background: #4332BD; }
    .mini { font-size: 12px; color: #666; }

    .result {
      background-color: #fafafa; padding: 18px; border-radius: 14px; text-align: right;
      line-height: 1.9; white-space: pre-line;  /* Ù…Ù‡Ù…: Ø®Ø·ÙˆØ· Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ù‚ÛŒÙ‚ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯ */
    }
    .error { color: #d33; font-size: 12px; text-align: right; min-height: 18px; margin: -6px 0 10px; }
    .usage-counter { margin-top: 10px; font-size: 14px; color: #555; }

    /* ---- Download Modal ---- */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.4); backdrop-filter: blur(3px);
      display: none; align-items: center; justify-content: center; padding: 16px; z-index: 999;
    }
    .modal {
      width: 100%; max-width: 420px; background: #fff; border-radius: 20px; overflow: hidden;
      box-shadow: 0 12px 32px rgba(0,0,0,.15);
    }
    .modal-header {
      background-image: linear-gradient(135deg, #4332BD, #6f58ff, #E96742);
      color: #fff; text-align: right; padding: 14px 16px;
    }
    .modal-header .close {
      background: transparent; border: 0; color: #fff; font-size: 18px; width: auto;
      float: left; margin-top: -4px; cursor: pointer;
    }
    .modal-body { padding: 10px; text-align: right; }
    .option {
      display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 14px;
      border: 1px solid #eee; text-decoration: none; color: #111; margin: 6px 0;
      transition: .15s ease; background: #fff;
    }
    .option:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,.06); }
    .option .arrow { margin-inline-start: auto; opacity: .8; }
    .option.web:hover { border-color: #4332BD; background: rgba(67,50,189,.05); }
    .option.bazaar:hover { border-color: #E96742; background: rgba(233,103,66,.06); }
    .option.myket:hover { border-color: #0B0B0F; background: rgba(0,0,0,.05); }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://uploadkon.ir/uploads/8c7604_25file-0000000073346243969ca320550ec0a2.png" class="logo" alt="Repay Logo" />
    <h1>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø³ÙˆØ¯ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h1>
    <p>Ø·Ø±Ø­ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯Ø› Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¬Ø²Ø¦ÛŒØ§Øª Ùˆ Ø¯Ú©Ù…Ù‡Ù” Ø´Ø±ÙˆØ¹ Ø³Ø±ÛŒØ¹ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.</p>

    <!-- Download App Button -->
    <div style="margin-bottom:12px">
      <button id="btnOpenModal" type="button" class="btn-secondary">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</button>
    </div>

    <div class="row">
      <select id="plan" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­" onchange="onPlanChange()">
        <option value="gold123" selected>ğŸ¥‡ Ø·Ù„Ø§ÛŒÛŒ Û±Û²Û³Ùª</option>
        <option value="credit">ğŸ’³ Ø·Ø±Ø­ Ø§Ø¹ØªØ¨Ø§Ø±</option>
        <option value="vip">â­ VIP (Ø¯Ù„Ø®ÙˆØ§Ù‡)</option>
        <option value="upfront">ğŸ’  Ø³ÙˆØ¯ ÛŒÚ©Ø¬Ø§</option>
      </select>

      <!-- Ù…Ø¯Øª: Ø¨Ø±Ø§ÛŒ VIP ØºÛŒØ±ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      <select id="duration" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Øª"></select>
    </div>

    <!-- VIP Controls -->
    <div id="vipControls" style="display:none; text-align:right; margin-top:-6px;">
      <label class="mini">Ù…Ø¯Øª (Ù…Ø§Ù‡)</label>
      <input id="vipMonths" type="range" min="1" max="36" value="12" oninput="document.getElementById('vipMonthsVal').innerText=this.value">
      <div class="mini">Ù…Ø¯Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: <b><span id="vipMonthsVal">12</span> Ù…Ø§Ù‡</b></div>

      <label class="mini" style="margin-top:8px;">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ</label>
      <input id="vipAPR" type="range" min="0.01" max="0.61" step="0.01" value="0.30"
             oninput="document.getElementById('vipAPRVal').innerText=(this.value*100).toFixed(2)+'%'">
      <div class="mini">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: <b><span id="vipAPRVal">30.00%</span></b></div>
    </div>

    <input id="amount" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)" />
    <div id="amountError" class="error"></div>

    <button id="calcBtn" type="button" onclick="calculate()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>

    <div class="result" id="result" aria-live="polite"></div>

    <a id="ctaStart" href="https://my.repay.pro" target="_blank" rel="noreferrer noopener">
      <button type="button">Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø´Ø±ÙˆØ¹ Ú©Ù†</button>
    </a>

    <div class="usage-counter">ğŸ“Š count : <span id="useCount">0</span></div>
  </div>

  <!-- Download Modal -->
  <div id="downloadModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="dl-title">
    <div class="modal">
      <div class="modal-header">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div id="dl-title" style="font-weight:700;">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø±ÛŒÙ¾ÛŒ</div>
          <button id="btnCloseModal" class="close" aria-label="Ø¨Ø³ØªÙ†">âœ•</button>
        </div>
        <div style="font-size:12px; opacity:.85; margin-top:4px;">ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
      </div>
      <div class="modal-body">
        <a class="option web" href="https://my.repay.pro" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">ğŸŒ</div>
          <div>
            <div style="font-weight:600;">ÙˆØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</div>
            <div style="font-size:12px; color:#666;">Ø¨Ø¯ÙˆÙ† Ù†ØµØ¨ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø®Ù„ Ù…Ø±ÙˆØ±Ú¯Ø±</div>
          </div>
          <div class="arrow">â†—</div>
        </a>
        <a class="option bazaar" href="http://cafebazaar.ir/app/?id=io.rebix.pay&ref=share" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">ğŸ›’</div>
          <div>
            <div style="font-weight:600;">Ú©Ø§ÙÙ‡ Ø¨Ø§Ø²Ø§Ø±</div>
            <div style="font-size:12px; color:#666;">Ù†ØµØ¨ Ø§Ø² Ù…Ø§Ø±Ú©Øª Ø¨Ø§Ø²Ø§Ø±</div>
          </div>
          <div class="arrow">â†—</div>
        </a>
        <a class="option myket" href="https://myket.ir/app/io.rebix.pay" target="_blank" rel="noreferrer noopener">
          <div style="font-size:22px">ğŸ“±</div>
          <div>
            <div style="font-weight:600;">Ù…Ø§ÛŒÚ©Øª</div>
            <div style="font-size:12px; color:#666;">Ù†ØµØ¨ Ø§Ø² Ù…Ø§Ø±Ú©Øª Ù…Ø§ÛŒÚ©Øª</div>
          </div>
          <div class="arrow">â†—</div>
        </a>
      </div>
      <div style="background:#f6f6f6; color:#666; font-size:11px; text-align:right; padding:10px 12px;">
        Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ø± Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø¨Ù‡ ØµÙØ­Ù‡Ù” Ù†ØµØ¨ Ù…Ø±Ø¨ÙˆØ· Ù‡Ø¯Ø§ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯.
      </div>
    </div>
  </div>

<script>
  // ---------- Plans ----------
  // Ù…Ø¨Ù„Øºâ€ŒÙ‡Ø§: ØªÙˆÙ…Ø§Ù†
  const plans = {
    gold123: {
      label: "Ø·Ù„Ø§ÛŒÛŒ Û±Û²Û³Ùª",
      type: "termYield",
      termMonths: 24,
      termYield: 1.23,     // Ø³ÙˆØ¯ Ú©Ù„ Ø¯ÙˆØ±Ù‡
      min: 25000000,       // Ø­Ø¯Ø§Ù‚Ù„ 25,000,000 ØªÙˆÙ…Ø§Ù†
    },
    credit: {
      label: "Ø·Ø±Ø­ Ø§Ø¹ØªØ¨Ø§Ø±",
      type: "dailyAPR_withLoan",
      termMonths: 3,
      investAPR: 0.25,     // Ø³Ø§Ù„Ø§Ù†Ù‡ Ø±ÙˆØ²Ø´Ù…Ø§Ø±
      loanAPR: 0.23,       // Ø³Ø§Ù„Ø§Ù†Ù‡ Ø±ÙˆØ²Ø´Ù…Ø§Ø±
      loanFactor: 1/3,     // ÛŒÚ© Ø³ÙˆÙ… Ø³Ø±Ù…Ø§ÛŒÙ‡
      min: 15000000,
    },
    vip: {
      label: "VIP",
      type: "dailyAPR_flexible",
      minMonths: 1,
      maxMonths: 36,
      minAPR: 0.01,
      maxAPR: 0.61,
      min: 0,
    },
    upfront: {
      label: "Ø³ÙˆØ¯ ÛŒÚ©Ø¬Ø§",
      type: "dailyAPR_upfront",
      termMonths: 5,
      apr: 0.42,
      min: 10000000,
    }
  };

  // ---------- Formatting ----------
  const nfFA = new Intl.NumberFormat('fa-IR');
  const formatNumber = (n) => nfFA.format(n);

  function normalizeDigits(str){
    const fa = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹', ar = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
    return (str || '').replace(/[\u06F0-\u06F9\u0660-\u0669]/g, d => {
      const i = fa.indexOf(d); if (i > -1) return String(i);
      const j = ar.indexOf(d); if (j > -1) return String(j);
      return d;
    });
  }
  function numberFromInput(val){
    const normalized = normalizeDigits(val);
    const raw = normalized.replace(/[^\d]/g, '');
    return raw ? parseInt(raw, 10) : NaN;
  }
  function formatInputAmount(e){
    const input = e.target;
    const n = numberFromInput(input.value);
    if (Number.isNaN(n)) { input.value = ''; return; }
    input.value = formatNumber(n);
  }
  function setError(msg){ document.getElementById('amountError').textContent = msg || ''; }

  // ---------- Daily APR (roozshomar) ----------
  const proratedByMonths = (apr, months) => apr * ((months * 30) / 365);

  // ---------- UI logic ----------
  function onPlanChange(){
    const key = document.getElementById('plan').value;
    const p = plans[key];
    const sel = document.getElementById('duration');
    const vipBox = document.getElementById('vipControls');

    sel.innerHTML = '';
    vipBox.style.display = 'none';
    sel.disabled = false;

    if (p.type === 'termYield') {
      const opt = document.createElement('option');
      opt.value = String(p.termMonths);
      opt.textContent = `${p.termMonths} Ù…Ø§Ù‡Ù‡`;
      sel.appendChild(opt);
    } else if (p.type === 'dailyAPR_withLoan') {
      const opt = document.createElement('option');
      opt.value = String(p.termMonths);
      opt.textContent = `${p.termMonths} Ù…Ø§Ù‡Ù‡`;
      sel.appendChild(opt);
    } else if (p.type === 'dailyAPR_upfront') {
      const opt = document.createElement('option');
      opt.value = String(p.termMonths);
      opt.textContent = `${p.termMonths} Ù…Ø§Ù‡Ù‡`;
      sel.appendChild(opt);
    } else if (p.type === 'dailyAPR_flexible') {
      vipBox.style.display = '';
      sel.disabled = true;
    }

    const minTxt = p.min > 0 ? `Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº ${formatNumber(p.min)} ØªÙˆÙ…Ø§Ù†` : 'Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)';
    document.getElementById('amount').placeholder = minTxt;

    setError('');
    document.getElementById('result').innerHTML = '';
  }

  // ---------- Calculations ----------
  function calcTermYield(P, termYield){
    const profit = Math.round(P * termYield);
    const monthly = Math.round(profit / 24);
    return { profit, monthly, finalAmount: P + profit };
  }
  function calcDailyAPR(P, apr, months){
    const r = proratedByMonths(apr, months);
    const profit = Math.round(P * r);
    const monthly = Math.max(0, Math.round(profit / months));
    return { r, profit, monthly, finalAmount: P + profit };
  }
  function calcCreditPlan(P){
    const pl = plans.credit;
    const inv = calcDailyAPR(P, pl.investAPR, pl.termMonths);
    const loanAmount  = Math.round(P * pl.loanFactor);
    const loanRate    = proratedByMonths(pl.loanAPR, pl.termMonths);
    const loanInterest = Math.round(loanAmount * loanRate);
    const loanMonthly  = Math.round(loanInterest / pl.termMonths);
    return {
      investProfit: inv.profit,
      investMonthly: inv.monthly,
      finalAmount: P + inv.profit,
      loanAmount, loanMonthly
    };
  }
  function calcUpfront(P){
    const pl = plans.upfront;
    const r = proratedByMonths(pl.apr, pl.termMonths);
    const upfrontInterest = Math.round(P * r);
    const monthly = Math.round(upfrontInterest / pl.termMonths);
    return {
      monthly, total: upfrontInterest, finalAtMaturity: P
    };
  }

  // ---------- Show result (STRICT templates) ----------
  function calculate(){
    const key = document.getElementById('plan').value;
    const p = plans[key];
    const amount = numberFromInput(document.getElementById('amount').value);

    if (Number.isNaN(amount)) { setError('Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'); return; }
    if (amount < p.min) { setError(`Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº Ø¨Ø±Ø§ÛŒ Â«${p.label}Â» ${formatNumber(p.min)} ØªÙˆÙ…Ø§Ù† Ø§Ø³Øª.`); return; }
    setError('');

    const months = (p.type === 'dailyAPR_flexible')
      ? parseInt(document.getElementById('vipMonths').value, 10)
      : parseInt(document.getElementById('duration').value, 10);

    let text = '';
    if (p.type === 'termYield') {
      const out = calcTermYield(amount, p.termYield);
      text =
`Ù…Ø¯Øª: ${p.termMonths} Ù…Ø§Ù‡Ù‡
Ø³ÙˆØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${formatNumber(out.monthly)} ØªÙˆÙ…Ø§Ù†
Ø³ÙˆØ¯ Ú©Ù„: ${formatNumber(out.profit)} ØªÙˆÙ…Ø§Ù†
Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¯Ø± Ø³Ø±Ø±Ø³ÛŒØ¯: ${formatNumber(out.finalAmount)} ØªÙˆÙ…Ø§Ù†`;
    } else if (p.type === 'dailyAPR_withLoan') {
      const out = calcCreditPlan(amount);
      // Ù†Ø³Ø®Ù‡ Ù…Ø±ØªØ¨ Ùˆ Ù…Ù†Ø¸Ù… Ø·Ø¨Ù‚ Ù‚Ø§Ù„Ø¨ Ø®ÙˆØ§Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡
      text =
`Ù…Ø¯Øª: ${p.termMonths} Ù…Ø§Ù‡Ù‡
Ø³ÙˆØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${formatNumber(out.investMonthly)} ØªÙˆÙ…Ø§Ù†
Ø³ÙˆØ¯ Ú©Ù„: ${formatNumber(out.investProfit)} ØªÙˆÙ…Ø§Ù†
Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¯Ø± Ø³Ø±Ø±Ø³ÛŒØ¯: ${formatNumber(out.finalAmount)} ØªÙˆÙ…Ø§Ù†
---------------------------------
Ø§Ø¹ØªØ¨Ø§Ø± Ø¯Ø±ÛŒØ§ÙØªÛŒ : ${formatNumber(out.loanAmount)} ØªÙˆÙ…Ø§Ù†
Ø³ÙˆØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø§Ø¹ØªØ¨Ø§Ø± : ${formatNumber(out.loanMonthly)} ØªÙˆÙ…Ø§Ù†`;
    } else if (p.type === 'dailyAPR_flexible') {
      const apr = Math.min(Math.max(parseFloat(document.getElementById('vipAPR').value), p.minAPR), p.maxAPR);
      const out = calcDailyAPR(amount, apr, months);
      text =
`Ù…Ø¯Øª: ${months} Ù…Ø§Ù‡Ù‡
Ø³ÙˆØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${formatNumber(out.monthly)} ØªÙˆÙ…Ø§Ù†
Ø³ÙˆØ¯ Ú©Ù„: ${formatNumber(out.profit)} ØªÙˆÙ…Ø§Ù†
Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¯Ø± Ø³Ø±Ø±Ø³ÛŒØ¯: ${formatNumber(out.finalAmount)} ØªÙˆÙ…Ø§Ù†`;
    } else if (p.type === 'dailyAPR_upfront') {
      const out = calcUpfront(amount);
      text =
`Ù…Ø¯Øª: ${p.termMonths} Ù…Ø§Ù‡Ù‡
Ø³ÙˆØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${formatNumber(out.monthly)} ØªÙˆÙ…Ø§Ù†
Ø³ÙˆØ¯ Ú©Ù„: ${formatNumber(out.total)} ØªÙˆÙ…Ø§Ù†
Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¯Ø± Ø³Ø±Ø±Ø³ÛŒØ¯: ${formatNumber(out.finalAtMaturity)} ØªÙˆÙ…Ø§Ù†`;
    }

    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‚ÛŒÙ‚ Ù‡Ù…Ø§Ù† Ù‚Ø§Ù„Ø¨ (Ø¨Ø¯ÙˆÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÙ‡)
    const resultEl = document.getElementById('result');
    resultEl.textContent = text;

    updateCounter(); // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
  }

  // ---------- Counter (GAS JSONP) ----------
  const COUNTER_NS  = 'repay_calc';        // Ù‡Ù…Ø§Ù† namespace Ø´Ù…Ø§ (Ø¨Ø¯ÙˆÙ† ØµÙØ± Ø´Ø¯Ù†)
  const COUNTER_KEY = 'usage_count';
  const API_BASE = 'https://script.google.com/macros/s/AKfycbxkeNkd__in37pKasVS0lhD7ffK7iB2dxS1A7hSgY8R9TngJLjfRwcIp4kuowDs7O-4/exec';

  const URL_GET = `${API_BASE}?op=get&ns=${COUNTER_NS}&key=${COUNTER_KEY}`;
  const URL_HIT = `${API_BASE}?op=hit&ns=${COUNTER_NS}&key=${COUNTER_KEY}`;

  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      window[cb] = data => { resolve(data); cleanup(); };
      const s = document.createElement('script');
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
      s.onerror = () => { reject(); cleanup(); };
      document.body.appendChild(s);
      function cleanup(){ delete window[cb]; s.remove(); }
    });
  }
  function setCount(v){ document.getElementById('useCount').innerText = (v ?? 0); }
  function getCurrentCount(){ jsonp(URL_GET).then(d => setCount(d.value)).catch(() => setCount(0)); }
  function updateCounter(){
    const el = document.getElementById('useCount');
    el.innerText = (parseInt(el.innerText || '0', 10) + 1);
    jsonp(URL_HIT).then(d => setCount(d.value)).catch(() => {});
  }

  // ---------- Download Modal logic ----------
  (function setupModal(){
    const modal = document.getElementById('downloadModal');
    const openBtn = document.getElementById('btnOpenModal');
    const closeBtn = document.getElementById('btnCloseModal');

    function open(){ modal.style.display = 'flex'; }
    function close(){ modal.style.display = 'none'; }

    openBtn.addEventListener('click', open);
    closeBtn.addEventListener('click', close);
    modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
  })();

  // ---------- init ----------
  document.getElementById('amount').addEventListener('input', formatInputAmount);
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('plan').value = 'gold123'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    onPlanChange();
    getCurrentCount();
  });
</script>
</body>
</html>
